# Kubernetes Secrets and Hashicorp Vault

## Task1

#### Create a secret
```bash
egor@egor-Swift-SF314-43:~/InnoSubjects/F23/DevOps/devops-core-course-labs/k8s$ kubectl create secret generic my-secret --from-literal=secretK='secret password'
secret/my-secret created
```

#### Check the secret

```bash
egor@egor-Swift-SF314-43:~/InnoSubjects/F23/DevOps/devops-core-course-labs/k8s$ kubectl get secret my-secret
NAME        TYPE     DATA   AGE
my-secret   Opaque   1      2m12s
```

```bash
egor@egor-Swift-SF314-43:~/InnoSubjects/F23/DevOps/devops-core-course-labs/k8s$ kubectl get secret my-secret -o jsonpath='{.data.*}' | base64 -d
secret password
```

#### Get yaml file from kubectl

```bash
egor@egor-Swift-SF314-43:~/InnoSubjects/F23/DevOps/devops-core-course-labs/k8s$ kubectl get secret my-secret -o yaml
apiVersion: v1
data:
  secondK: c2Vjb25kCg==
  secretK: c2VjcmV0IHBhc3N3b3Jk
kind: Secret
metadata:
  annotations:
    meta.helm.sh/release-name: python-helm-app
    meta.helm.sh/release-namespace: default
  creationTimestamp: "2023-11-13T21:36:42Z"
  labels:
    app.kubernetes.io/managed-by: Helm
  name: my-secret
  namespace: default
  resourceVersion: "48810"
  uid: 6f5c4dec-115c-4607-904f-c659116b5c87
type: Opaque
```

#### Install and get secrets
```bash
egor@egor-Swift-SF314-43:~/InnoSubjects/F23/DevOps/devops-core-course-labs/k8s$ helm install python-helm-app ./helm-python-app
NAME: python-helm-app
LAST DEPLOYED: Tue Nov 14 00:41:22 2023
NAMESPACE: default
STATUS: deployed
REVISION: 1
NOTES:
1. Get the application URL by running these commands:
  export NODE_PORT=$(kubectl get --namespace default -o jsonpath="{.spec.ports[0].nodePort}" services python-helm-app-helm-python-app)
  export NODE_IP=$(kubectl get nodes --namespace default -o jsonpath="{.items[0].status.addresses[0].address}")
  echo http://$NODE_IP:$NODE_PORT

egor@egor-Swift-SF314-43:~/InnoSubjects/F23/DevOps/devops-core-course-labs/k8s$ kubectl get po
NAME                                               READY   STATUS    RESTARTS   AGE
python-helm-app-helm-python-app-76dc46b484-9m8gn   1/1     Running   0          40s

egor@egor-Swift-SF314-43:~/InnoSubjects/F23/DevOps/devops-core-course-labs/k8s$ kubectl exec python-helm-app-helm-python-app-76dc46b484-9m8gn -- e
nv
PATH=/usr/local/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
HOSTNAME=python-helm-app-helm-python-app-76dc46b484-9m8gn
my-secret=secret password
my-secret-two=second
...
```

## Task2


#### Set and Get vault metadata
```bash
egor@egor-Swift-SF314-43:~/InnoSubjects/F23/DevOps/devops-core-course-labs$ kubectl exec -it vault-0 -- /bin/sh
/ $ vault secrets enable -path=internal kv-v2
Success! Enabled the kv-v2 secrets engine at: internal/
/ $ vault kv put internal/database/config username="db-wq" password="db-wq-password"
======== Secret Path ========
internal/data/database/config

======= Metadata =======
Key                Value
---                -----
created_time       2023-11-13T23:36:34.550724483Z
custom_metadata    <nil>
deletion_time      n/a
destroyed          false
version            1
/ $ vault kv get internal/database/config
======== Secret Path ========
internal/data/database/config

======= Metadata =======
Key                Value
---                -----
created_time       2023-11-13T23:36:34.550724483Z
custom_metadata    <nil>
deletion_time      n/a
destroyed          false
version            1

====== Data ======
Key         Value
---         -----
password    db-wq-password
username    db-wq
```


#### Set kubernetes in vault
```bash
egor@egor-Swift-SF314-43:~/InnoSubjects/F23/DevOps/devops-core-course-labs$ kubectl exec -it vault-0 -- /bin/sh
/ $ vault auth enable kubernetes
Success! Enabled kubernetes auth method at: kubernetes/
/ $ vault write auth/kubernetes/config \
>       kubernetes_host="https://$KUBERNETES_PORT_443_TCP_ADDR:443"
Success! Data written to: auth/kubernetes/config
/ $ vault policy write internal-app - <<EOF
> path "internal/data/database/config" {
>    capabilities = ["read"]
> }
> EOF
Success! Uploaded policy: internal-app
/ $ vault write auth/kubernetes/role/internal-app \
>       bound_service_account_names=internal-app \
>       bound_service_account_namespaces=default \
>       policies=internal-app \
>       ttl=24h
Success! Data written to: auth/kubernetes/role/internal-app
```

#### Upgrade python app
```bash
egor@egor-Swift-SF314-43:~/InnoSubjects/F23/DevOps/devops-core-course-labs/k8s$ helm install python-helm-app ./helm-python-app
NAME: python-helm-app
LAST DEPLOYED: Tue Nov 14 03:04:23 2023
NAMESPACE: default
STATUS: deployed
REVISION: 1
NOTES:
1. Get the application URL by running these commands:
  export NODE_PORT=$(kubectl get --namespace default -o jsonpath="{.spec.ports[0].nodePort}" services python-helm-app-helm-python-app)
  export NODE_IP=$(kubectl get nodes --namespace default -o jsonpath="{.items[0].status.addresses[0].address}")
  echo http://$NODE_IP:$NODE_PORT


egor@egor-Swift-SF314-43:~/InnoSubjects/F23/DevOps/devops-core-course-labs$ kubectl get pods
NAME                                               READY   STATUS    RESTARTS   AGE
python-helm-app-helm-python-app-6d947bcb88-k4qdh   1/1     Running   0          32s
vault-0                                            1/1     Running   0          64m
vault-agent-injector-5cd8b87c6c-nbhwg              1/1     Running   0          64m
```


#### Application checkers
```bash
egor@egor-Swift-SF314-43:~/InnoSubjects/F23/DevOps/devops-core-course-labs/k8s$ kubectl exec python-helm-app-helm-python-app-d865675d4-fxhhs -it /
bin/sh
kubectl exec [POD] [COMMAND] is DEPRECATED and will be removed in a future version. Use kubectl exec [POD] -- [COMMAND] instead.
Defaulted container "helm-python-app" out of: helm-python-app, vault-agent, vault-agent-init (init)
# ls
main.py  requirements.txt
# cd /vault
# ls
secrets
# cd secrets
# ls
database-config.txt
# cat database-config.txt
data: map[password:db-wq-password username:db-wq]
metadata: map[created_time:2023-11-13T23:36:34.550724483Z custom_metadata:<nil> deletion_time: destroyed:false version:1]
# df -h      
Filesystem      Size  Used Avail Use% Mounted on
overlay         468G  168G  277G  38% /
tmpfs            64M     0   64M   0% /dev
tmpfs           7.2G  4.0K  7.2G   1% /vault/secrets
/dev/nvme0n1p2  468G  168G  277G  38% /etc/hosts
shm              64M     0   64M   0% /dev/shm
tmpfs           7.2G   12K  7.2G   1% /run/secrets/kubernetes.io/serviceaccount
tmpfs           3.6G     0  3.6G   0% /proc/asound
tmpfs           3.6G     0  3.6G   0% /proc/acpi
tmpfs           3.6G     0  3.6G   0% /proc/scsi
tmpfs           3.6G     0  3.6G   0% /sys/firmware
```

#### Set templates

```bash
egor@egor-Swift-SF314-43:~/InnoSubjects/F23/DevOps/devops-core-course-labs/k8s$ helm install python-helm-app ./helm-python-app
NAME: python-helm-app
LAST DEPLOYED: Tue Nov 14 22:18:01 2023
NAMESPACE: default
STATUS: deployed
REVISION: 1
NOTES:
1. Get the application URL by running these commands:
  export NODE_PORT=$(kubectl get --namespace default -o jsonpath="{.spec.ports[0].nodePort}" services python-helm-app-helm-python-app)
  export NODE_IP=$(kubectl get nodes --namespace default -o jsonpath="{.items[0].status.addresses[0].address}")
  echo http://$NODE_IP:$NODE_PORT
```

```bash
gor@egor-Swift-SF314-43:~/InnoSubjects/F23/DevOps/devops-core-course-labs/k8s$ kubectl get po
NAME                                               READY   STATUS    RESTARTS   AGE
python-helm-app-helm-python-app-546b8445b7-dccql   2/2     Running   0          3m3s
vault-0                                            1/1     Running   0          20h
vault-agent-injector-5cd8b87c6c-nbhwg              1/1     Running   0          20h
```

```bash
egor@egor-Swift-SF314-43:~/InnoSubjects/F23/DevOps/devops-core-course-labs/k8s$ kubectl exec python-helm-app-helm-python-app-546b8445b7-dccql -it 
/bin/sh
kubectl exec [POD] [COMMAND] is DEPRECATED and will be removed in a future version. Use kubectl exec [POD] -- [COMMAND] instead.
Defaulted container "helm-python-app" out of: helm-python-app, vault-agent, vault-agent-init (init)
# cat /vault/secrets/database-config.txt
My Secrets = db-wq:db-wq-password# 
```


## Bonuses


### Resource Management
```bash
egor@egor-Swift-SF314-43:~/InnoSubjects/F23/DevOps/devops-core-course-labs/k8s$ kubectl describe pod python-helm-app-helm-python-app-546b8445b7-dccql
...
Containers:
  helm-python-app:
    Container ID:   *********
    Image:          wildqueue/devops-hw:tagname
    Image ID:       *********
    Port:           8008/TCP
    Host Port:      0/TCP
    State:          Running
      Started:      Tue, 14 Nov 2023 22:18:26 +0300
    Ready:          True
    Restart Count:  0
    Limits:
      cpu:     200m
      memory:  256Mi
    Requests:
      cpu:     100m
      memory:  128Mi
...
```


### One more application
```bash
egor@egor-Swift-SF314-43:~/InnoSubjects/F23/DevOps/devops-core-course-labs/k8s$ helm install golang-helm-app ./helm-golang-app
NAME: golang-helm-app
LAST DEPLOYED: Tue Nov 14 01:19:49 2023
NAMESPACE: default
STATUS: deployed
REVISION: 1
NOTES:
1. Get the application URL by running these commands:
  export NODE_PORT=$(kubectl get --namespace default -o jsonpath="{.spec.ports[0].nodePort}" services golang-helm-app-helm-golang-app)
  export NODE_IP=$(kubectl get nodes --namespace default -o jsonpath="{.items[0].status.addresses[0].address}")
  echo http://$NODE_IP:$NODE_PORT

egor@egor-Swift-SF314-43:~/InnoSubjects/F23/DevOps/devops-core-course-labs/k8s$ kubectl get po
NAME                                               READY   STATUS    RESTARTS   AGE
golang-helm-app-helm-golang-app-78d6494f8c-f5fkz   1/1     Running   0          34s

egor@egor-Swift-SF314-43:~/InnoSubjects/F23/DevOps/devops-core-course-labs/k8s$ kubectl exec golang-helm-app-helm-golang-app-78d6494f8c-f5fkz -- e
nv
PATH=/go/bin:/usr/local/go/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
HOSTNAME=golang-helm-app-helm-golang-app-78d6494f8c-f5fkz
my-secret=secret password
my-secret-two=second
```
